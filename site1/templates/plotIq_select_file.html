{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

<div class="container">
  <h1>PlotLy Example plots</h1>
  <p class="lead">Click to see...</p>
</div>

<div class="container">
  <table class="table table-striped table-hover">
    {% for filename in filenames %}
    <tr>
      <td>{{ filename }}</td>
      <td><a class="btn btn-default" href="{% url 'app1:plotIq' filename=filename %}" role="button">View</a></td>
      <td><div class="plot" data-filename="{{ filename }}"></div></td>
    </tr>
    {% endfor %}
  </table>
</div>
<!-- /.container -->

{% endblock %}

{% block localjs %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.js" type="text/javascript"></script>

<script type="text/javascript">

  var prefix = "{% static 'data/' %}";
  var plots = d3.selectAll(".plot");
  var filenames = plots[0].map(d => d3.select(d).attr("data-filename"));
  console.log(filenames);

  var q = queue(4);
  filenames.forEach(function(filename) {
      var csv = d3.csv(prefix + filename)
          .row(d => ({ Q: +d.Q, I: +d.I, dev: +d.dev }));
      q = q.defer(csv.get);
  });

  q.awaitAll(function(error, csvs) {
      if (error) { console.log(error); return; }

      var width = 40,
          height = 40,
          x = (d => d.Q),
          y = (d => d.I),
          xScale = d3.scale.linear().range([0, width]).domain([
              d3.min(csvs.map(d => d3.min(d, x))),
              d3.max(csvs.map(d => d3.max(d, x))),
          ]),
          yScale = d3.scale.linear().range([height, 0]).domain([
              d3.min(csvs.map(d => d3.min(d, y))),
              d3.max(csvs.map(d => d3.max(d, y))),
          ]),
          line = d3.svg.line().x(d => xScale(x(d))).y(d => yScale(y(d)));

      csvs.forEach(function(d) {
          d.sort((a, b) => x(b) - x(a));
      });
      plots.datum((d, i) => csvs[i]);

      var svgs = plots.selectAll("svg").data(d => [d]);
      svgs.enter().append('svg')
          .attr('width', width)
          .attr('height', height);

      var paths = svgs.selectAll("path").data(d => [d]);
      paths.enter().append('path')
          .attr('stroke-width', 1)
          .attr('fill', 'none')
          .attr('stroke', 'black');
      paths
          .attr("d", function(d) {
              var xScale = d3.scale.linear()
                  .range([0, width])
                  .domain(d3.extent(d, x));

              var yScale = d3.scale.linear()
                  .range([height, 0])
                  .domain(d3.extent(d, y));

              var line = d3.svg.line()
                  .x(dd => xScale(x(dd)))
                  .y(dd => yScale(y(dd)))

              //console.log(xScale.domain(), yScale.domain(), d);

              return line(d);
          });
  });

</script>

{% endblock %}
