<!DOCTYPE html>
<meta charset="UTF-8" >
<title>PlotFit</title>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/7.1.0/css/bootstrap-slider.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<body>
<script>
Function.prototype.toJSON = function() {
    return this.name + "()";
};

function ProxyMaker(depth=0) {
    return new Proxy({}, {
        get(target, name) {
            var undesired = ['splice', 'toJSON', '__proto__'];
            if (undesired.includes(name)) {
                return undefined;
            }

            if (name === 'isProxy') {
                return true;
            }

            console.log(depth, 'GET', name);

            if (!(name in target)) {
                if (depth < 10) {
                    target[name] = ProxyMaker(depth + 1);
                }
            }

            return target[name];
        },
        set(target, name, value) {
            console.log(depth, 'SET', name, value);
            target[name] = value;
        },
    });
}

_module = ProxyMaker();

function module(fn) {
    var exports = new ProxyMaker();
    fn(exports, _module);

    function p(name, _) {
        try {
            console.log(name, JSON.stringify(_, true, 2));
        } catch (e) {
            console.log(name, _);
        }
        return _;
    }

    console.log(_module);
    copy(_module, exports);
    p('_module', _module);

    function copy(target, source) {
        p('target', target);
        p('source', source);
        for (var key in source) {
            p('key', key);
            p('source[key]', source[key]);
            if (!Object.prototype.hasOwnProperty.call(source, key)) {
                p('skipping', null);
                continue;
            }

            if (source[key].isProxy) {
                p('+recursing', key);
                copy(target[key], source[key]);
                p('-recursing', key);
            } else /*if (typeof source[key] === 'object') {
                p('object', source[key]);
                for (var k in source[key]) {
                    target[key][k] = source[key][k];
                }
            } else*/ {
                p('other', source[key]);
                target[key] = source[key];
            }
        }
    }
}
</script>
<script type="text/javascript" src="https://vuejs.org/js/vue.js"></script>
<script>
module(function(exports, {}) {
    exports.Vue = window.Vue;
    delete window.Vue;
});
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vuex/0.8.2/vuex.js"></script>
<script>
module(function(exports, {}) {
    exports.Vuex = Vuex;
    delete window.Vuex;
});
</script>
<script>
module(function(exports, { Vuex, Vue }) {
    Vue.use(Vuex);

    const state = {
        sidebar: {
            left: false,
            right: true,
        },
    };

    const mutations = {
        SET_SIDEBAR({ sidebar }, { left, right }) {
            sidebar.left = left;
            sidebar.right = right;
        },
    };

    exports.vuex.store = new Vuex.Store({
        state,
        mutations,
    });
});
</script>
<script>
module(function(exports, {}) {
    exports.vuex.actions = {
        setSidebar({ dispatch, state: { sidebar } }, { left, right }) {
            var sidebar = { left: sidebar.left, right: sidebar.right };
            sidebar.left = left;
            sidebar.right = right;

            dispatch('SET_SIDEBAR', sidebar);
        },
    };
});
</script>
<script>
module(function(exports, {}) {
    exports.vuex.getters = {
        getSidebar({ sidebar }) {
            console.log('sidebar', sidebar);
            return sidebar;
        },
    };
});
</script>
<style>
#page-content-wrapper {
    width: 100%;
    position: relative;
    padding: 15px;
}
@media(min-width:768px) {
    #page-content-wrapper {
        padding: 20px;
    }
}
</style>

<script type="text/html" id="MainPlot">
    <div id="page-content-wrapper">
        <a class="btn btn-default menu-toggle"
           data-toggle="tooltip" data-placement="right"
           title="Click to toggle the file list sidebar."
           @click="updateSidebarLeft">
            <span class="glyphicon glyphicon-transfer" aria-hidden="true"></span>
        </a>

        <a class="btn btn-default menu-toggle pull-right"
           data-toggle="tooltip"
           data-placement="left" title="Click to toggle the file list sidebar."
           @click="updateSidebarRight">
            <span class="glyphicon glyphicon-transfer" aria-hidden="true"></span>
        </a>

        <!-- <plotly-plot></plotly-plot> -->

        <div style="width: 100%">
            <!-- <bootstrap-slider
                 :max="fittingData.length"
                 :min="0"
                 :value="fitting.domain"
                 @input="bootstrapSliderUpdate"
                 @change="bootstrapSliderUpdate"
                 ></bootstrap-slider> -->
        </div>
    </div>
</script>

<script>
module(function(exports, {
    components: {
        PlotlyPlot,
        BootstrapSlider,
    },
    vuex: {
        getters: { getSidebar },
        actions: { setSidebar },
    },
}) {
    console.log('getSidebar', getSidebar);
    exports.components.MainPlot = {
        name: 'MainPlot',
        template: '#MainPlot',
        vuex: {
            getters: {
                sidebar: getSidebar,
            },
            actions: {
                setSidebar,
            },
        },
        methods: {
            updateSidebarRight() {
                console.log('foo', this.sidebar);
                this.setSidebar({ right: !this.sidebar.right });
            },
            updateSidebarLeft() {
                this.setSidebar({ left: !this.sidebar.left });
            },
            bootstrapSliderUpdate(e) {
                this.setFitting({ target: { value: {
                    expr: this.fitting.expr,
                    isFitting: this.fitting.isFitting,
                    scope: [],
                    domain: e.target.value,
                }}});
            },
        },
        components: {
            BootstrapSlider,
            PlotlyPlot,
        },
    };
});
</script>
<style>
#wrapper {
    padding-left: 0;
}
#wrapper.toggled-left {
    padding-left: 250px;
}
#sidebar-left-wrapper {
    z-index: 1000;
    position: fixed;
    left: 250px;
    width: 0;
    height: 100%;
    margin-left: -250px;
    overflow-y: auto;
    border-right: none;
}
#wrapper.toggled-left #sidebar-left-wrapper {
    width: 250px;
    border-right: solid;
}
#wrapper.toggled-left #page-content-wrapper {
    position: absolute;
    margin-right: -250px;
}
@media(min-width:768px) {
    #wrapper {
        padding-left: 250px;
    }
    #wrapper.toggled-left {
        padding-left: 0;
    }
    #sidebar-left-wrapper {
        width: 250px;
        border-right: solid;
    }
    #wrapper.toggled-left #sidebar-left-wrapper {
        width: 0;
        border-right: none;
    }
    #wrapper.toggled-left #page-content-wrapper {
        margin-right: 0;
    }
}
</style>

<script type="text/html" id="LeftSidebar">
    <div id="sidebar-left-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-12">
                    <div class="btn-group-vertical">
                        <h3>Graph Controls</h3>
                        <!-- <x-scale></x-scale> -->
                        <!-- <y-scale></y-scale> -->

                        <h3>Fitting Controls</h3>
                        <!-- <fitting-control></fitting-control> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script>
module(function(exports, { components: { XScale, YScale, FittingControl } }) {
    exports.components.LeftSidebar = {
        name: 'LeftSidebar',
        template: '#LeftSidebar',
        components: {
            XScale,
            YScale,
            FittingControl,
        },
    };
});
</script>
<script type="text/html" id="PlotfitApp" >
    <div id="wrapper" :class="{ 'toggled-right': sidebar.right, 'toggled-left': sidebar.left }">
        <left-sidebar></left-sidebar>
        <!-- <right-sidebar></right-sidebar> -->
        <main-plot></main-plot>
    </div>
</script>

<script>
module(function(exports, {
    components: { LeftSidebar, MainPlot, RightSidebar },
    vuex: {
        store,
        getters: { getSidebar },
    },
}) {
    console.log('STORE', store);
    exports.components.PlotfitApp = {
        name: 'PlotfitApp',
        template: '#PlotfitApp',
        store,
        vuex: {
            getters: {
                sidebar: getSidebar,
            },
        },
        components: {
            LeftSidebar,
            MainPlot,
            RightSidebar,
        }
    };
});
</script>
<plotfit-app></plotfit-app>
<script>
module(function(exports, {
    Vue,
    components: { PlotfitApp },
}) {

    new Vue({
        el: 'body',
        components: {
            PlotfitApp,
        },
    });
});
</script>
